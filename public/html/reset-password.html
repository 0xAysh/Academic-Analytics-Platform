<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - Academic Analytics Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles/pages/auth.css">
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <div class="icon-box">üîë</div>
      <h2>Set New Password</h2>
      <p>Enter your reset token and choose a new secure password for your account.</p>
      <div class="feature-list">
        <div class="feature-item">
          <div class="feature-icon">‚úÖ</div>
          <div class="feature-text">
            <span class="feature-title">Secure Reset</span>
            <span class="feature-desc">Your token expires after 1 hour</span>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">üîí</div>
          <div class="feature-text">
            <span class="feature-title">Strong Password</span>
            <span class="feature-desc">Minimum 8 characters required</span>
          </div>
        </div>
        <div class="feature-item">
          <div class="feature-icon">‚ö°</div>
          <div class="feature-text">
            <span class="feature-title">Quick Access</span>
            <span class="feature-desc">Login immediately after reset</span>
          </div>
        </div>
      </div>
    </div>
    <div class="right-panel">
      <h2>Reset Password</h2>
      <p>Enter your reset token and new password</p>
      <form id="resetPasswordForm">
        <div class="form-group">
          <label class="form-label" for="token">Reset Token</label>
          <div class="input-wrapper">
            <i class="fas fa-key"></i>
            <input autocomplete="off" class="form-input" id="token" placeholder="Enter reset token" type="text" required />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="newPassword">New Password</label>
          <div class="input-wrapper">
            <i class="fas fa-lock"></i>
            <input autocomplete="new-password" class="form-input" id="newPassword" placeholder="Enter new password" type="password" required />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="confirmPassword">Confirm New Password</label>
          <div class="input-wrapper">
            <i class="fas fa-lock"></i>
            <input autocomplete="new-password" class="form-input" id="confirmPassword" placeholder="Confirm new password" type="password" required />
          </div>
        </div>
        <div id="errorMessage" class="error-message" role="alert"></div>
        <div id="successMessage" class="success-message" role="alert"></div>
        <button class="sign-in-btn" type="submit">Reset Password <i class="fas fa-arrow-right"></i></button>
      </form>
      <div class="signup-text">
        <a class="signup-link" href="/html/login.html">‚Üê Back to Login</a> | 
        <a class="signup-link" href="/html/forgot-password.html">Request New Token</a>
      </div>
    </div>
  </div>
  <script type="module">
    import { resetPassword } from '/js/api/auth.js';
    
    const form = document.getElementById('resetPasswordForm');
    const submitBtn = form?.querySelector('button[type="submit"]');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const tokenInput = document.getElementById('token');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    
    // Check if token is in URL
    const urlParams = new URLSearchParams(window.location.search);
    const tokenFromUrl = urlParams.get('token');
    if (tokenFromUrl && tokenInput) {
      tokenInput.value = tokenFromUrl;
    }
    
    function showError(message) {
      if (errorMessage) {
        errorMessage.textContent = message;
        errorMessage.classList.add('show');
      }
      if (successMessage) {
        successMessage.classList.remove('show');
        successMessage.textContent = '';
      }
    }
    
    function showSuccess(message) {
      if (successMessage) {
        successMessage.textContent = message;
        successMessage.classList.add('show');
      }
      if (errorMessage) {
        errorMessage.classList.remove('show');
        errorMessage.textContent = '';
      }
    }
    
    function hideMessages() {
      if (errorMessage) {
        errorMessage.classList.remove('show');
        errorMessage.textContent = '';
      }
      if (successMessage) {
        successMessage.classList.remove('show');
        successMessage.textContent = '';
      }
    }
    
    // Clear messages when user starts typing
    if (tokenInput) {
      tokenInput.addEventListener('input', hideMessages);
    }
    if (newPasswordInput) {
      newPasswordInput.addEventListener('input', hideMessages);
    }
    if (confirmPasswordInput) {
      confirmPasswordInput.addEventListener('input', hideMessages);
    }
    
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        hideMessages();
        
        const token = (tokenInput || {}).value.trim() || '';
        const newPassword = (newPasswordInput || {}).value || '';
        const confirmPassword = (confirmPasswordInput || {}).value || '';
        
        // Validate fields
        if (!token) {
          showError('Please enter your reset token.');
          return;
        }
        
        if (!newPassword) {
          showError('Please enter a new password.');
          return;
        }
        
        if (newPassword.length < 8) {
          showError('Password must be at least 8 characters long.');
          return;
        }
        
        if (newPassword !== confirmPassword) {
          showError('Passwords do not match.');
          return;
        }
        
        if (submitBtn) {
          const currentWidth = submitBtn.offsetWidth;
          submitBtn.disabled = true;
          submitBtn.style.minWidth = currentWidth + 'px';
          submitBtn.innerHTML = '<span>Resetting...</span> <i class="fas fa-spinner fa-spin"></i>';
        }
        
        try {
          const response = await resetPassword(token, newPassword);
          
          if (response.success) {
            showSuccess(response.message || 'Password has been reset successfully! Redirecting to login...');
            
            // Clear form
            if (tokenInput) tokenInput.value = '';
            if (newPasswordInput) newPasswordInput.value = '';
            if (confirmPasswordInput) confirmPasswordInput.value = '';
            
            // Redirect to login after delay
            setTimeout(() => {
              window.location.href = '/html/login.html';
            }, 2000);
          } else {
            showError(response.error || 'Failed to reset password. Please check your token and try again.');
          }
        } catch (error) {
          showError(error.message || 'Failed to reset password. Please check your token and try again.');
        } finally {
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Reset Password <i class="fas fa-arrow-right"></i>';
            submitBtn.style.minWidth = '';
          }
        }
      });
    }
  </script>
</body>
</html>

